@model IEnumerable<APP.Models.DangKyViewModel>

<div class="container mt-5 text-center">
    <h3 class="fw-bold text-danger mb-4">
        <i class="bi bi-person-vcard"></i> DANH SÁCH ĐĂNG KÝ KHÁM BỆNH
    </h3>

    <form method="get" asp-action="Index" class="d-flex justify-content-center mb-4 align-items-center">
        <input type="text" name="search" value="@ViewBag.Search"
               class="form-control me-2 search-box"
               placeholder="Nhập mã KCB hoặc họ tên..." />
        <select name="pageSize" class="form-select me-2" style="max-width: 120px;">
            <option value="25" selected="@(ViewBag.PageSize == 25)">25 dòng</option>
            <option value="50" selected="@(ViewBag.PageSize == 50)">50 dòng</option>
            <option value="100" selected="@(ViewBag.PageSize == 100)">100 dòng</option>
        </select>
        <button type="submit" class="btn btn-danger me-2">🔍 Tìm kiếm</button>
        <button type="submit" form="deleteForm" class="btn btn-outline-danger"
                onclick="return confirm('Bạn có chắc muốn xóa các dòng đã chọn không?');">
            🗑️ Xóa đã chọn
        </button>
    </form>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="text-muted">
            Hiển thị @Model.Count() / @ViewBag.TotalRecords bản ghi
        </div>
        <nav aria-label="Pagination">
            <ul class="pagination mb-0">
                @if (ViewBag.CurrentPage > 1)
                {
                    <li class="page-item">
                        <a class="page-link" href="?search=@ViewBag.Search&page=1&pageSize=@ViewBag.PageSize">Đầu</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?search=@ViewBag.Search&page=@(ViewBag.CurrentPage - 1)&pageSize=@ViewBag.PageSize">‹</a>
                    </li>
                }

                @for (int i = Math.Max(1, ViewBag.CurrentPage - 2); i <= Math.Min(ViewBag.TotalPages, ViewBag.CurrentPage + 2); i++)
                {
                    <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                        <a class="page-link" href="?search=@ViewBag.Search&page=@i&pageSize=@ViewBag.PageSize">@i</a>
                    </li>
                }

                @if (ViewBag.CurrentPage < ViewBag.TotalPages)
                {
                    <li class="page-item">
                        <a class="page-link" href="?search=@ViewBag.Search&page=@(ViewBag.CurrentPage + 1)&pageSize=@ViewBag.PageSize">›</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?search=@ViewBag.Search&page=@ViewBag.TotalPages&pageSize=@ViewBag.PageSize">Cuối</a>
                    </li>
                }
            </ul>
        </nav>
    </div>

    <form asp-action="DeleteSelected" method="post" id="deleteForm"
          onsubmit="return confirm('Bạn có chắc muốn xóa các dòng đã chọn không?');">

    @* Success alert removed; using centered toast instead *@
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-warning">@TempData["Error"]</div>
    }

    <div class="table-responsive shadow-sm">
        <table class="table table-bordered table-hover compact-table align-middle text-center">
            <thead class="table-header-red text-white">
                <tr>
                    <th>Mã KCB</th>
                    <th>Họ tên</th>
                    <th>Ngày ĐK</th>
                    <th>Ngày sinh</th>
                    <th>Giới tính</th>
                    <th>Số CCCD</th>
                    <th>Mã nghề nghiệp</th>
                    <th>Mã đối tượng</th>
                    <th>Phòng</th>
                    <th>Khoa</th>
                    <th>Nhân viên</th>
                    <th>Chức vụ</th>
                    <th>Cấp bậc</th>
                    <th>Đơn vị</th>
                    <th>Nơi làm việc</th>
                    <th>Số nhà</th>
                    <th>Thôn/phố</th>
                    <th>Xã</th>
                    <th>Tỉnh</th>
                    <th>Điện thoại</th>
                    <th>BHXH</th>
                    <th>Loại hình KCB</th>
                    <th>Hình thức đến</th>
                    <th>Lý do vào viện</th>
                    <th>Thao tác</th>
                    <th>Chọn</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@item.makcb</td>
                        <td class="text-start">@item.hoten</td>
                        <td>@(item.ngaydk?.ToString("dd/MM/yyyy") ?? "-")</td>
                        <td>@(item.ngaysinh?.ToString("dd/MM/yyyy") ?? "-")</td>
                        <td>@(item.maphai == 1 ? "Nam" : item.maphai == 2 ? "Nữ" : "-")</td>
                        <td>@item.socmnd</td>
                        <td>@(item.manghenghiep == 0 ? "-" : item.manghenghiep)</td>
                        <td>@(item.madoituong == 0 ? "-" : item.madoituong)</td>
                        <td>@item.tenphong</td>
                        <td>@item.tenkk</td>
                        <td>@item.manv</td>
                        <td>@item.tenchucvu</td>
                        <td>@item.tencapbac</td>
                        <td>@item.madonvi</td>
                        <td class="text-start">@item.noilamviec</td>
                        <td class="text-start">@item.sonha</td>
                        <td class="text-start">@item.thonpho</td>
                        <td class="text-start">@item.tenxa</td>
                        <td class="text-start">@item.tentinh</td>
                        <td>@item.dienthoai</td>
                        <td>@item.sobhxh</td>
                        <td>@item.diengiai</td>
                        <td>@item.tenhtd</td>
                        <td class="text-start">
                            @{
                                var fullLyDo = item.lydovv130 ?? "";
                                var shortLyDo = fullLyDo.Length > 40 ? fullLyDo.Substring(0, 40) + "..." : fullLyDo;
                            }
                            <span class="clickable-text" data-bs-toggle="modal"
                                  data-bs-target="#detailModal"
                                  data-title="Lý do vào viện"
                                  data-content="@fullLyDo">
                                @shortLyDo
                            </span>
                        </td>
                        <td>
                            <a asp-action="Edit" asp-route-makcb="@item.makcb" class="btn btn-info btn-sm">✏️ Sửa</a>
                        </td>
                        <td>
                            <input type="checkbox" name="selectedIds" value="@item.makcb" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    </form>
</div>

@if (TempData["Success"] != null)
{
    <div id="successToast" class="center-toast">
        @TempData["Success"]
    </div>
    <script>
        setTimeout(function () {
            var toast = document.getElementById('successToast');
            if (toast) {
                toast.style.transition = 'opacity 300ms ease';
                toast.style.opacity = '0';
                setTimeout(function () { toast.remove(); }, 350);
            }
        }, 3500);
    </script>
}

    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fw-bold" id="modalTitle">Chi tiết</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-start" id="modalContent"></div>
            </div>
        </div>
    </div>

    <style>
        body {
            background-color: #fff5f7;
            font-family: 'Segoe UI', sans-serif;
        }
        h3 {
            color: #e91e63;
            font-weight: 700;
        }
        .search-box {
            max-width: 280px;
            border: 1px solid #e91e63;
            border-radius: 6px;
            font-size: 14px;
            height: 36px;
        }

        .btn-danger {
            background-color: #e91e63 !important;
            border-color: #e91e63 !important;
            color: #fff !important;
            font-weight: 600;
        }

        .btn-outline-light {
            background-color: white !important;
            border: 1px solid #e91e63 !important;
            color: #e91e63 !important;
            font-weight: 600;
        }

            .btn-outline-light:hover {
                background-color: #e91e63 !important;
                color: #fff !important;
            }

        .btn-info {
            background-color: #e91e63 !important;
            color: #fff !important;
            font-weight: 600;
        }

        .table-header-red {
            background-color: #e91e63 !important;
            color: #fff !important;
            text-transform: uppercase;
        }

        .table.compact-table th,
        .table.compact-table td {
            padding: 6px 8px !important;
            font-size: 13px;
            vertical-align: middle;
        }

        .table-hover tbody tr:hover {
            background-color: #fff0f3 !important;
        }

        .table th, .table td {
            white-space: nowrap !important;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
            vertical-align: middle !important;
        }

    .center-toast {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1080;
        min-width: 280px;
        max-width: 80vw;
        background: rgba(33, 37, 41, 0.95);
        color: #fff;
        padding: 14px 18px;
        border-radius: 8px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        text-align: center;
        font-weight: 600;
    }


        .clickable-text {
            color: #e91e63;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            max-width: 250px;
        }

            .clickable-text:hover {
                text-decoration: underline;
            }

        .daky-inline {
            display: inline-block;
            max-width: 250px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #e91e63;
            cursor: pointer;
        }

        .pagination .page-link {
            color: #e91e63;
            border-color: #e91e63;
        }

        .pagination .page-item.active .page-link {
            background-color: #e91e63;
            border-color: #e91e63;
            color: white;
        }

        .pagination .page-link:hover {
            background-color: #fff0f3;
            border-color: #e91e63;
        }
    </style>


    <script>const modal = document.getElementById('detailModal');
        modal.addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget;
            const title = button.getAttribute('data-title');
            const content = button.getAttribute('data-content');
            modal.querySelector('#modalTitle').textContent = title;
            modal.querySelector('#modalContent').textContent = content || "Không có thông tin.";
        });</script>
