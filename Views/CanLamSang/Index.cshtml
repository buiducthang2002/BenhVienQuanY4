@model IEnumerable<APP.Models.CanLamSang>
<div class="container mt-5 text-center">
    <h3 class="fw-bold text-danger mb-4">
        <i class="bi bi-heart-pulse"></i> 🧬 DANH SÁCH CẬN LÂM SÀNG
    </h3>

    @* Success alert removed; using centered toast instead *@
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["WarningMessage"] != null)
    {
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-circle"></i> @TempData["WarningMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <form asp-action="Search" method="post" class="d-flex justify-content-center mb-4 align-items-center">
        <input type="text" name="makcb" class="form-control me-2 search-box"
               placeholder="Nhập mã KCB..." />
        <button type="submit" class="btn btn-danger me-2">
            <i class="bi bi-search"></i> 🔍 Tìm kiếm
        </button>
        <button type="submit" form="deleteForm" class="btn btn-outline-light"
                onclick="return confirm('Bạn có chắc muốn xóa các dòng đã chọn không?');">
            <i class="bi bi-trash"></i> 🗑️ Xóa các dòng đã chọn
        </button>
    </form>

    <form asp-action="DeleteSelected" method="post" id="deleteForm">
        <table class="table table-bordered table-hover compact-table shadow-sm text-center align-middle">
        <thead class="table-header-red text-white">
            <tr>
                <th>Mã HH</th>
                <th>Tên dịch vụ</th>
                <th>Mã KCB</th>
                <th>Họ tên</th>
                <th>Barcode</th>
                <th>Người làm</th>
                <th>Kết luận</th>
                <th>Đã ký</th>
                <th>Thao tác</th>
                <th>Chọn</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>@item.mahh</td>
                    <td class="text-start tendichvu-cell">@item.tendichvu</td>
                    <td>@item.makcb</td>
                    <td>@item.hoten </td>
                    <td>@item.barcode</td>
                    <td>@item.manvlam</td>
                    <td class="text-start ketluan-cell">@item.ketluan</td>
                    <td>
                        @if (!string.IsNullOrEmpty(item.daky))
                        {
                            <span class="badge bg-success">Đã ký</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Chưa ký</span>
                        }
                    </td>
                    <td>
                        <div class="d-flex flex-column gap-1">
                        <button type="button" class="btn btn-detail btn-sm"
                                data-bs-toggle="modal" data-bs-target="#detailModal"
                                data-mathanhtoan="@item.mathanhtoan"
                                data-daduyet="@(item.daduyet == true ? "Đã duyệt" : "Chưa duyệt")"
                                data-ngaylam="@item.ngaylam?.ToString("dd/MM/yyyy HH:mm")"
                                data-ngaykhopbc="@item.ngaykhopBC?.ToString("dd/MM/yyyy HH:mm")"
                                data-ngaytrakq="@item.ngaytraKQ?.ToString("dd/MM/yyyy HH:mm")"
                                data-ailam="@item.ailam"
                                data-datrakq="@(item.datrakq ? "Đã trả" : "Chưa trả")"
                                data-ngayth="@item.ngayth?.ToString("dd/MM/yyyy HH:mm")"
                                data-ngayketqualis="@item.ngayketquaLIS?.ToString("dd/MM/yyyy HH:mm")">
                            <i class="bi bi-info-circle"></i> Chi tiết
                        </button>
                        <button type="button" class="btn btn-edit btn-sm"
                                data-bs-toggle="modal" data-bs-target="#editModal"
                                data-makcb="@item.makcb"
                                data-mahh="@item.mahh"
                                data-ngaylam="@item.ngaylam?.ToString("yyyy-MM-ddTHH:mm")"
                                data-ngaykhopbc="@item.ngaykhopBC?.ToString("yyyy-MM-ddTHH:mm")"
                                data-ngaytrakq="@item.ngaytraKQ?.ToString("yyyy-MM-ddTHH:mm")"
                                data-ngayth="@item.ngayth?.ToString("yyyy-MM-ddTHH:mm")"
                                data-ngayketqualis="@item.ngayketquaLIS?.ToString("yyyy-MM-ddTHH:mm")">
                            <i class="bi bi-pencil-square"></i> Sửa
                        </button>
                        </div>
                    </td>
                    <td>
                        <input type="checkbox" name="selectedItems" value="@($"{item.makcb}|{item.mahh}|{item.barcode}")" />
                    </td>
                </tr>
            }
        </tbody>
        </table>
    </form>
</div>

<!-- Modal Chi tiết -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header text-white" style="background-color:#e91e63;">
                <h5 class="modal-title" id="detailModalLabel"><i class="bi bi-clipboard2-pulse"></i> Chi tiết kết quả CLS</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-bordered table-sm detail-modal-table">
                    <tbody>
                        <tr><th>Mã thanh toán</th><td id="d-mathanhtoan"></td></tr>
                        <tr><th>Đã duyệt</th><td id="d-daduyet"></td></tr>
                        <tr><th>Ngày làm</th><td id="d-ngaylam"></td></tr>
                        <tr><th>Ngày khớp BC</th><td id="d-ngaykhopbc"></td></tr>
                        <tr><th>Ngày trả KQ</th><td id="d-ngaytrakq"></td></tr>
                        <tr><th>Ai làm</th><td id="d-ailam"></td></tr>
                        <tr><th>Đã trả KQ</th><td id="d-datrakq"></td></tr>
                        <tr><th>Ngày TH</th><td id="d-ngayth"></td></tr>
                        <tr><th>Ngày KQ LIS</th><td id="d-ngayketqualis"></td></tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Sửa chi tiết -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header text-white" style="background-color:#e91e63;">
                <h5 class="modal-title" id="editModalLabel"><i class="bi bi-pencil-square"></i> Sửa chi tiết kết quả CLS</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="EditDetail" method="post">
            <div class="modal-body">
                <input type="hidden" id="e-makcb" name="makcb" />
                <input type="hidden" id="e-mahh"  name="mahh"  />
                <table class="table table-bordered table-sm detail-modal-table">
                    <tbody>
                        <tr>
                            <th>Ngày làm</th>
                            <td><input type="datetime-local" id="e-ngaylam" name="ngaylam" class="form-control form-control-sm" /></td>
                        </tr>
                        <tr>
                            <th>Ngày khớp BC</th>
                            <td><input type="datetime-local" id="e-ngaykhopbc" name="ngaykhopBC" class="form-control form-control-sm" /></td>
                        </tr>
                        <tr>
                            <th>Ngày trả KQ</th>
                            <td><input type="datetime-local" id="e-ngaytrakq" name="ngaytraKQ" class="form-control form-control-sm" /></td>
                        </tr>
                        <tr>
                            <th>Ngày thực hiện</th>
                            <td><input type="datetime-local" id="e-ngayth" name="ngayth" class="form-control form-control-sm" /></td>
                        </tr>
                        <tr>
                            <th>Ngày KQ LIS</th>
                            <td><input type="datetime-local" id="e-ngayketqualis" name="ngayketquaLIS" class="form-control form-control-sm" /></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="submit" class="btn btn-save"><i class="bi bi-floppy"></i> Lưu</button>
            </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.getElementById('detailModal').addEventListener('show.bs.modal', function (e) {
        var btn = e.relatedTarget;
        document.getElementById('d-mathanhtoan').textContent   = btn.dataset.mathanhtoan  || '';
        document.getElementById('d-daduyet').textContent       = btn.dataset.daduyet       || '';
        document.getElementById('d-ngaylam').textContent       = btn.dataset.ngaylam       || '';
        document.getElementById('d-ngaykhopbc').textContent    = btn.dataset.ngaykhopbc    || '';
        document.getElementById('d-ngaytrakq').textContent     = btn.dataset.ngaytrakq     || '';
        document.getElementById('d-ailam').textContent         = btn.dataset.ailam         || '';
        document.getElementById('d-datrakq').textContent       = btn.dataset.datrakq       || '';
        document.getElementById('d-ngayth').textContent        = btn.dataset.ngayth        || '';
        document.getElementById('d-ngayketqualis').textContent = btn.dataset.ngayketqualis || '';
    });

    document.getElementById('editModal').addEventListener('show.bs.modal', function (e) {
        var btn = e.relatedTarget;
        document.getElementById('e-makcb').value          = btn.dataset.makcb          || '';
        document.getElementById('e-mahh').value           = btn.dataset.mahh           || '';
        document.getElementById('e-ngaylam').value        = btn.dataset.ngaylam        || '';
        document.getElementById('e-ngaykhopbc').value     = btn.dataset.ngaykhopbc     || '';
        document.getElementById('e-ngaytrakq').value      = btn.dataset.ngaytrakq      || '';
        document.getElementById('e-ngayth').value         = btn.dataset.ngayth         || '';
        document.getElementById('e-ngayketqualis').value  = btn.dataset.ngayketqualis  || '';
    });
</script>

@if (TempData["SuccessMessage"] != null)
{
    <div id="successToast" class="center-toast">
        <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
    </div>
    <script>
        setTimeout(function () {
            var toast = document.getElementById('successToast');
            if (toast) {
                toast.style.transition = 'opacity 300ms ease';
                toast.style.opacity = '0';
                setTimeout(function () { toast.remove(); }, 350);
            }
        }, 3500);
    </script>
}


<style>
    body {
        background-color: #fff5f7;
        font-family: 'Segoe UI', sans-serif;
    }

    h3 {
        font-weight: 700;
        color: #e91e63;
    }

    .search-box {
        max-width: 240px;
        border: 1px solid #e91e63;
        border-radius: 5px;
        font-size: 14px;
        height: 34px;
    }


    .btn-danger {
        background-color: #e91e63 !important;
        border-color: #e91e63 !important;
        font-weight: 600;
        font-size: 14px;
        padding: 5px 12px;
    }

    .btn-outline-light {
        background-color: white !important;
        border: 1px solid #e91e63 !important;
        color: #e91e63 !important;
        font-weight: 600;
        font-size: 14px;
        padding: 5px 12px;
    }

        .btn-outline-light:hover {
            background-color: #e91e63 !important;
            color: #fff !important;
        }


    .table-header-red {
        background-color: #e91e63 !important;
        color: #fff !important;
        text-transform: uppercase;
    }

    .table.compact-table th,
    .table.compact-table td {
        padding: 6px 8px !important;
        font-size: 13px;
        vertical-align: middle;
        text-align: center;
    }

    .table-hover tbody tr:hover {
        background-color: #fff0f3 !important;
    }

    .table td, .table th {
        border: 1px solid #f3b8c5;
    }

    .shadow-sm {
        box-shadow: 0 3px 6px rgba(233, 30, 99, 0.1);
    }
    .ketluan-cell {
        text-align: left !important;
        padding-left: 10px !important;
        font-weight: 500;
        color: #333;
    }
    .tendichvu-cell {
        text-align: left !important;
        padding-left: 10px !important;
        font-weight: 500;
        color: #333;
    }

    /* Style cho thông báo */
    .alert {
        border-radius: 8px;
        font-weight: 500;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .alert-success {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }

    .alert-danger {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }

    .alert-warning {
        background-color: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
    }

    .alert .btn-close {
        padding: 0.75rem 1rem;
    }

    .btn-detail {
        background-color: #fff0f6 !important;
        border: 1px solid #e91e63 !important;
        color: #e91e63 !important;
        font-size: 12px;
        padding: 3px 8px;
        white-space: nowrap;
    }

        .btn-detail:hover {
            background-color: #e91e63 !important;
            color: #fff !important;
        }

    .btn-edit {
        background-color: #fff8e1 !important;
        border: 1px solid #f59e0b !important;
        color: #b45309 !important;
        font-size: 12px;
        padding: 3px 8px;
        white-space: nowrap;
    }

        .btn-edit:hover {
            background-color: #f59e0b !important;
            color: #fff !important;
        }

    .btn-save {
        background-color: #e91e63 !important;
        border-color: #e91e63 !important;
        color: #fff !important;
        font-weight: 600;
        font-size: 14px;
    }

    .detail-modal-table th {
        width: 40%;
        background-color: #fff5f7;
        color: #c2185b;
        font-weight: 600;
    }

    .center-toast {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1080;
        min-width: 280px;
        max-width: 80vw;
        background: rgba(33, 37, 41, 0.95);
        color: #fff;
        padding: 14px 18px;
        border-radius: 8px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        text-align: center;
        font-weight: 600;
    }
</style>